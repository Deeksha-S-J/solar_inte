#include <WiFi.h>
#include <HTTPClient.h>
#include <Wire.h>
#include <Adafruit_INA219.h>

#define DEVICE_ID "ESP_02"     // âœ… Change for each ESP32
#define LED_PIN 9

const char* ssid = "TP-Link_83B8";
const char* password = "15400338";
const char* serverURL = "http://192.168.0.169:3000/api/panels/sensor-update";

Adafruit_INA219 ina219;

unsigned long lastSendTime = 0;
unsigned long lastBlinkTime = 0;
bool ledState = false;

float safeValue(float value) {
  if (isnan(value) || isinf(value)) {
    return 0.0;
  }
  return value;
}

void setup() {
  pinMode(LED_PIN, OUTPUT);
  delay(1000);
  Serial.begin(115200);

  Wire.begin();
  ina219.begin();

  WiFi.begin(ssid, password);
  Serial.println("Starting...");
}

void loop() {
  // ðŸ”µ Blink LED ALWAYS (independent of WiFi)
  if (millis() - lastBlinkTime >= 500) {
    lastBlinkTime = millis();
    ledState = !ledState;
    digitalWrite(LED_PIN, ledState);
  }

  // ðŸŸ¢ Print WiFi status
  static unsigned long lastStatusPrint = 0;
  if (millis() - lastStatusPrint >= 3000) {
    lastStatusPrint = millis();

    if (WiFi.status() == WL_CONNECTED) {
      Serial.print("Connected. IP: ");
      Serial.println(WiFi.localIP());
    } else {
      Serial.println("WiFi not connected...");
    }
  }

  // ðŸ“¡ Send data every 5 seconds (only if connected)
  if (WiFi.status() == WL_CONNECTED && millis() - lastSendTime >= 5000) {
    lastSendTime = millis();

    float voltage = safeValue(ina219.getBusVoltage_V());
    float current = safeValue(ina219.getCurrent_mA());
    float power   = safeValue(ina219.getPower_mW());

    sendToBackend(voltage, current, power);
  }
}

void sendToBackend(float voltage, float current, float power) {
  HTTPClient http;
  http.begin(serverURL);
  http.addHeader("Content-Type", "application/json");

  String payload = "{\"device_id\":\"";
  payload += DEVICE_ID;
  payload += "\",\"voltage\":";
  payload += String(voltage, 3);
  payload += ",\"current\":";
  payload += String(current, 2);
  payload += ",\"power\":";
  payload += String(power, 2);
  payload += "}";

  Serial.println("Sending:");
  Serial.println(payload);

  int httpResponseCode = http.POST(payload);

  Serial.print("Server Response: ");
  Serial.println(httpResponseCode);

  http.end();
}
