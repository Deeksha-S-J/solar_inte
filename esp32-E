#include <WiFi.h>
#include <HTTPClient.h>
#include <Wire.h>
#include <Adafruit_INA219.h>
#include <Adafruit_SHT31.h>

#define DEVICE_ID "ESP_03"
#define LED_PIN 2          // ðŸ”¥ Safe pin on ESP32
#define SDA_PIN 21
#define SCL_PIN 22

const char* ssid = "TP-Link_83B8";
const char* password = "15400338";
const char* serverURL = "http://192.168.0.169:3000/api/panels/sensor-update";

Adafruit_INA219 ina219;
Adafruit_SHT31 sht31 = Adafruit_SHT31();

unsigned long lastSendTime = 0;
unsigned long lastBlinkTime = 0;
bool ledState = false;

float safeValue(float value) {
  if (isnan(value) || isinf(value)) {
    return 0.0;
  }
  return value;
}

void setup() {

  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);

  Serial.begin(115200);
  delay(2000);

  // ðŸ”¹ Proper I2C init for FireBeetle
  Wire.begin(SDA_PIN, SCL_PIN);
  delay(100);

  // INA219
  if (!ina219.begin()) {
    Serial.println("INA219 not found");
  } else {
    Serial.println("INA219 OK");
    ina219.setCalibration_16V_400mA();
  }

  // SHT31
  if (!sht31.begin(0x44)) {
    Serial.println("SHT31 not found");
  } else {
    Serial.println("SHT31 OK");
  }

  // WiFi connect
  WiFi.begin(ssid, password);
  Serial.println("Connecting to WiFi...");

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nWiFi Connected");
  Serial.print("ESP IP: ");
  Serial.println(WiFi.localIP());
}

void loop() {

  // ðŸ”µ LED Blink
  if (millis() - lastBlinkTime >= 500) {
    lastBlinkTime = millis();
    ledState = !ledState;
    digitalWrite(LED_PIN, ledState);
  }

  // ðŸŸ¢ Print WiFi Status
  static unsigned long lastStatusPrint = 0;
  if (millis() - lastStatusPrint >= 3000) {
    lastStatusPrint = millis();

    if (WiFi.status() == WL_CONNECTED) {
      Serial.print("Connected. IP: ");
      Serial.println(WiFi.localIP());
    } else {
      Serial.println("WiFi not connected...");
    }
  }

  // ðŸ“¡ Send Data Every 5 Seconds
  if (WiFi.status() == WL_CONNECTED && millis() - lastSendTime >= 5000) {

    lastSendTime = millis();

    float voltage = safeValue(ina219.getBusVoltage_V());
    float current = safeValue(ina219.getCurrent_mA());
    float power   = safeValue(ina219.getPower_mW());

    float temperature = safeValue(sht31.readTemperature());
    float humidity    = safeValue(sht31.readHumidity());

    Serial.println("----- SENSOR DATA -----");
    Serial.print("Voltage: "); Serial.println(voltage);
    Serial.print("Current: "); Serial.println(current);
    Serial.print("Power: "); Serial.println(power);
    Serial.print("Temperature: "); Serial.println(temperature);
    Serial.print("Humidity: "); Serial.println(humidity);

    sendToBackend(voltage, current, power, temperature, humidity);
  }
}

void sendToBackend(float voltage, float current, float power,
                   float temperature, float humidity) {

  HTTPClient http;
  http.setTimeout(3000);  // ðŸ”¥ prevent blocking
  http.begin(serverURL);
  http.addHeader("Content-Type", "application/json");

  String payload = "{";
  payload += "\"device_id\":\"" + String(DEVICE_ID) + "\",";
  payload += "\"voltage\":" + String(voltage, 3) + ",";
  payload += "\"current\":" + String(current, 2) + ",";
  payload += "\"power\":" + String(power, 2) + ",";
  payload += "\"temperature\":" + String(temperature, 2) + ",";
  payload += "\"humidity\":" + String(humidity, 2);
  payload += "}";

  Serial.println("Sending:");
  Serial.println(payload);

  int httpResponseCode = http.POST(payload);

  Serial.print("Server Response: ");
  Serial.println(httpResponseCode);

  http.end();
}
